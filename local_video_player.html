<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Video Player</title>
    <style>
        :root {
            --primary: #0a0a1a;
            --secondary: #1a1a2e;
            --accent: #1e40af;
            --accent-light: #3b82f6;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        h1 {
            color: var(--accent-light);
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: var(--text-secondary);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: var(--accent-light);
        }
        
        .video-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .video-item {
            background: var(--secondary);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
            position: relative;
        }
        
        .video-item:hover {
            transform: translateY(-5px);
        }
        
        .video-thumbnail {
            width: 100%;
            height: 180px;
            background: #2d2d5a;
            position: relative;
            overflow: hidden;
        }
        
        .video-thumbnail canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-thumbnail .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: rgba(59, 130, 246, 0.8);
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        .video-info {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .video-title {
            font-weight: bold;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }
        
        .edit-icon {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .edit-icon:hover {
            color: var(--accent-light);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .video-player {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px;
            background: #000;
            border-radius: 10px;
            z-index: 1000;
        }
        
        #mainVideo {
            width: 100%;
            border-radius: 10px 10px 0 0;
        }
        
        .player-controls {
            padding: 15px;
            background: var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 10px 10px;
        }
        
        .close-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--accent-light);
            grid-column: 1 / -1;
        }
        
        .no-videos {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            grid-column: 1 / -1;
        }
        
        .edit-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary);
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
            min-width: 300px;
        }
        
        .edit-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: var(--primary);
            border: 1px solid var(--accent);
            border-radius: 5px;
            color: var(--text);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Dynamic Video Player</h1>
            <p class="subtitle">Videos loaded from ./videos/movies/ with CSV metadata</p>
        </header>
        
        <div class="controls">
            <button class="btn" onclick="refreshVideos()">
                <i class="fas fa-sync-alt"></i> Refresh Videos
            </button>
            <button class="btn" onclick="exportMetadata()">
                <i class="fas fa-download"></i> Export Metadata
            </button>
            <button class="btn" onclick="importMetadata()">
                <i class="fas fa-upload"></i> Import Metadata
            </button>
        </div>
        
        <div class="video-gallery" id="videoGallery">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Scanning for videos...
            </div>
        </div>
    </div>
    
    <!-- Video Player Modal -->
    <div class="overlay" id="overlay"></div>
    <div class="video-player" id="videoPlayer">
        <video id="mainVideo" controls></video>
        <div class="player-controls">
            <span id="nowPlaying">Select a video to play</span>
            <button class="close-btn" id="closeBtn">Close</button>
        </div>
    </div>
    
    <!-- Edit Title Modal -->
    <div class="overlay" id="editOverlay"></div>
    <div class="edit-modal" id="editModal">
        <h3>Edit Movie Title</h3>
        <input type="text" class="edit-input" id="editTitleInput">
        <div class="modal-buttons">
            <button class="btn" onclick="saveTitle()">Save</button>
            <button class="close-btn" onclick="closeEditModal()">Cancel</button>
        </div>
    </div>
    
    <!-- Hidden file input for metadata import -->
    <input type="file" id="metadataFile" accept=".csv" style="display: none;">

    <script>
        // Global variables
        let videoMetadata = new Map(); // filename -> {title, customTitle}
        let currentEditFilename = null;
        
        // DOM elements
        const videoGallery = document.getElementById('videoGallery');
        const videoPlayer = document.getElementById('videoPlayer');
        const mainVideo = document.getElementById('mainVideo');
        const overlay = document.getElementById('overlay');
        const closeBtn = document.getElementById('closeBtn');
        const nowPlaying = document.getElementById('nowPlaying');
        const editModal = document.getElementById('editModal');
        const editOverlay = document.getElementById('editOverlay');
        const editTitleInput = document.getElementById('editTitleInput');
        const metadataFileInput = document.getElementById('metadataFile');

        // Video file extensions to look for
        const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.mkv'];
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            await loadMetadata();
            await scanAndLoadVideos();
        });

        // Load metadata from CSV
        async function loadMetadata() {
            try {
                // Try to load metadata from CSV file
                const response = await fetch('./videos/metadata.csv');
                if (response.ok) {
                    const csvText = await response.text();
                    parseMetadataCSV(csvText);
                } else {
                    console.log('No metadata CSV found, creating new one');
                    videoMetadata.clear();
                }
            } catch (error) {
                console.log('No existing metadata file, starting fresh');
                videoMetadata.clear();
            }
        }

        // Parse metadata CSV
        function parseMetadataCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            
            // Skip header row if exists
            const startIndex = lines[0].startsWith('filename,title,customTitle') ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const [filename, title, customTitle] = lines[i].split(',');
                if (filename && title) {
                    videoMetadata.set(filename, {
                        title: title,
                        customTitle: customTitle || title
                    });
                }
            }
        }

        // Scan videos directory and load them
        async function scanAndLoadVideos() {
            videoGallery.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Scanning for videos...</div>';
            
            try {
                // In a real implementation, you would fetch from a server endpoint
                // For this demo, we'll simulate scanning a directory
                const videoFiles = await simulateDirectoryScan();
                
                if (videoFiles.length === 0) {
                    videoGallery.innerHTML = '<div class="no-videos">No videos found in ./videos/movies/ folder</div>';
                    return;
                }
                
                await displayVideoGallery(videoFiles);
            } catch (error) {
                console.error('Error scanning videos:', error);
                videoGallery.innerHTML = '<div class="no-videos">Error scanning videos directory</div>';
            }
        }

        // Simulate directory scanning (replace with actual server call)
        async function simulateDirectoryScan() {
            // This would be replaced with a fetch to your server
            // For demo purposes, return some mock files
            return [
                'movie1.mp4',
                'movie2.mp4',
                'trailer.webm',
                'sample.mp4'
            ];
        }

        // Display video gallery
        async function displayVideoGallery(videoFiles) {
            videoGallery.innerHTML = '';
            
            for (const filename of videoFiles) {
                await createVideoItem(filename);
            }
            
            // Save metadata after loading all videos
            await saveMetadata();
        }

        // Create video item element
        async function createVideoItem(filename) {
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            
            // Get or create metadata
            let metadata = videoMetadata.get(filename);
            if (!metadata) {
                // Create default metadata
                const title = filename.replace(/\.[^/.]+$/, ""); // Remove extension
                metadata = { title, customTitle: title };
                videoMetadata.set(filename, metadata);
            }
            
            const videoPath = `./videos/movies/${filename}`;
            
            videoItem.innerHTML = `
                <div class="video-thumbnail">
                    <canvas width="300" height="180"></canvas>
                    <div class="play-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                </div>
                <div class="video-info">
                    <div class="video-title" title="${metadata.customTitle}">${metadata.customTitle}</div>
                    <div class="edit-icon" onclick="openEditModal('${filename}')">
                        <i class="fas fa-edit"></i>
                    </div>
                </div>
            `;
            
            videoGallery.appendChild(videoItem);
            
            // Generate thumbnail
            try {
                const canvas = videoItem.querySelector('canvas');
                await generateThumbnail(videoPath, canvas);
            } catch (error) {
                console.error(`Failed to generate thumbnail for ${filename}:`, error);
                const thumbnail = videoItem.querySelector('.video-thumbnail');
                thumbnail.style.background = '#2d2d5a';
            }
            
            // Add click event to play video
            videoItem.addEventListener('click', (e) => {
                if (!e.target.closest('.edit-icon')) {
                    playVideo(filename, metadata.customTitle);
                }
            });
        }

        // Generate thumbnail from video
        async function generateThumbnail(videoPath, canvas) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.crossOrigin = 'anonymous';
                video.src = videoPath;
                
                video.addEventListener('loadeddata', () => {
                    video.currentTime = Math.min(video.duration * 0.1, 10);
                });
                
                video.addEventListener('seeked', () => {
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    resolve();
                });
                
                video.addEventListener('error', reject);
                
                video.load();
            });
        }

        // Play selected video
        function playVideo(filename, title) {
            const videoPath = `./videos/movies/${filename}`;
            
            mainVideo.src = videoPath;
            nowPlaying.textContent = `Now playing: ${title}`;
            
            videoPlayer.style.display = 'block';
            overlay.style.display = 'block';
        }

        // Open edit modal
        function openEditModal(filename) {
            const metadata = videoMetadata.get(filename);
            if (metadata) {
                currentEditFilename = filename;
                editTitleInput.value = metadata.customTitle;
                editModal.style.display = 'block';
                editOverlay.style.display = 'block';
            }
        }

        // Close edit modal
        function closeEditModal() {
            editModal.style.display = 'none';
            editOverlay.style.display = 'none';
            currentEditFilename = null;
        }

        // Save edited title
        async function saveTitle() {
            if (!currentEditFilename) return;
            
            const newTitle = editTitleInput.value.trim();
            if (newTitle) {
                const metadata = videoMetadata.get(currentEditFilename);
                if (metadata) {
                    metadata.customTitle = newTitle;
                    await saveMetadata();
                    await refreshVideoDisplay();
                }
            }
            
            closeEditModal();
        }

        // Save metadata to CSV
        async function saveMetadata() {
            const csvContent = ['filename,title,customTitle'];
            
            for (const [filename, metadata] of videoMetadata) {
                csvContent.push(`${filename},${metadata.title},${metadata.customTitle}`);
            }
            
            // In a real implementation, you would send this to a server
            // For this demo, we'll create a downloadable file
            console.log('Metadata CSV:', csvContent.join('\n'));
            
            // Create download link (simulating save)
            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            // In a real app, you would send this to your server
            // For now, we'll just keep it in memory
            localStorage.setItem('videoMetadata', csvContent.join('\n'));
        }

        // Refresh video display
        async function refreshVideoDisplay() {
            const videoFiles = Array.from(videoMetadata.keys());
            await displayVideoGallery(videoFiles);
        }

        // Refresh videos (rescan directory)
        async function refreshVideos() {
            await scanAndLoadVideos();
        }

        // Export metadata
        function exportMetadata() {
            const csvContent = localStorage.getItem('videoMetadata') || 'filename,title,customTitle\n';
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'video_metadata.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Import metadata
        function importMetadata() {
            metadataFileInput.click();
        }

        // Handle metadata file import
        metadataFileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvText = e.target.result;
                    parseMetadataCSV(csvText);
                    refreshVideoDisplay();
                };
                reader.readAsText(file);
            }
        });

        // Close video player
        closeBtn.addEventListener('click', () => {
            videoPlayer.style.display = 'none';
            overlay.style.display = 'none';
            mainVideo.pause();
            mainVideo.currentTime = 0;
        });

        // Close when clicking overlay
        overlay.addEventListener('click', () => {
            videoPlayer.style.display = 'none';
            overlay.style.display = 'none';
            mainVideo.pause();
            mainVideo.currentTime = 0;
        });

        editOverlay.addEventListener('click', closeEditModal);
    </script>
</body>
</html>